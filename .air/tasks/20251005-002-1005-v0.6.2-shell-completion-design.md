# Task: Design v0.6.2 - Shell Completion

## Date
2025-10-05 10:05

## Prompt
Design and implement shell completion for bash, zsh, and fish to improve CLI usability.

## Design Requirements

### Goals
- Tab completion for all commands and subcommands
- Smart completion for arguments (resource names, task IDs, etc.)
- Support for bash, zsh, and fish shells
- Easy installation and activation
- Dynamic completion (reads from air-config.json)

### Target User Experience

```bash
air <TAB>                   # Shows: init, link, analyze, task, status, validate...
air link <TAB>              # Shows: add, list, remove
air link add ~/repos/<TAB>  # File path completion (native shell)
air analyze <TAB>           # Shows: repos/myapp, repos/lib, --all, --gap
air task <TAB>              # Shows: new, list, status, complete, archive
air task status <TAB>       # Shows: 20251005-001, 20251004-003, ... (actual task IDs)
air pr <TAB>                # Shows: myapp, docs (developer resources only)
```

### Implementation Approaches

**Option 1: Click Built-in Completion**
- Click has `@click.command()` → auto-generates completion
- Requires Click 8.0+
- Limited dynamic completion

**Option 2: Custom Completion Scripts**
- More control over dynamic completion
- Can read air-config.json for resource names
- Can scan .air/tasks/ for task IDs
- More maintenance

**Recommendation: Hybrid**
- Use Click's built-in for static completion
- Extend with custom functions for dynamic data

### Installation Methods

**Method 1: eval in shell RC**
```bash
# Add to ~/.bashrc or ~/.zshrc
eval "$(_AIR_COMPLETE=bash_source air)"   # bash
eval "$(_AIR_COMPLETE=zsh_source air)"    # zsh
```

**Method 2: air completion command**
```bash
air completion install bash   # Installs to ~/.bashrc
air completion install zsh    # Installs to ~/.zshrc
air completion install fish   # Installs to ~/.config/fish/completions/
air completion uninstall      # Removes from shell config
```

### Implementation Plan

**Phase 1: Click Completion Setup**
1. Verify Click version >=8.0 in requirements
2. Test basic completion works
3. Document manual activation

**Phase 2: Dynamic Completion**
1. Create completion helper functions:
   - `complete_resource_names()` - Read from air-config.json
   - `complete_task_ids()` - Scan .air/tasks/
   - `complete_analyzer_focus()` - Return: security, performance, etc.

2. Add to relevant commands:
   ```python
   @click.argument('resource', shell_complete=complete_resource_names)
   @click.option('--focus', shell_complete=complete_analyzer_focus)
   ```

**Phase 3: air completion command**
1. Create `src/air/commands/completion.py`
2. Implement subcommands:
   - `air completion install SHELL`
   - `air completion uninstall`
   - `air completion show SHELL` - Print script

3. Shell detection:
   - Auto-detect from $SHELL env var
   - Validate shell is supported

**Phase 4: Testing**
1. Manual testing in bash, zsh, fish
2. Test dynamic completion with real projects
3. Test installation/uninstall
4. Document in README and QUICKSTART

### Data Structures

```python
def complete_resource_names(ctx, param, incomplete):
    """Complete resource names from air-config.json."""
    config_path = Path.cwd() / "air-config.json"
    if not config_path.exists():
        return []
    
    config = json.loads(config_path.read_text())
    resources = []
    for resource_list in config.get("resources", {}).values():
        resources.extend([r["name"] for r in resource_list])
    
    return [r for r in resources if r.startswith(incomplete)]

def complete_task_ids(ctx, param, incomplete):
    """Complete task IDs from .air/tasks/."""
    tasks_dir = Path.cwd() / ".air/tasks"
    if not tasks_dir.exists():
        return []
    
    task_files = tasks_dir.glob("*.md")
    task_ids = [f.stem for f in task_files]
    
    return [tid for tid in task_ids if tid.startswith(incomplete)]
```

### Shell-Specific Notes

**Bash:**
- Uses `complete -C` or `complete -F`
- Simple but less powerful

**Zsh:**
- Most powerful completion system
- Can show descriptions with completions
- Format: `value:description`

**Fish:**
- Different syntax entirely
- Uses `complete -c air -a ...`
- Very user-friendly

### Documentation Updates

- README.md: Add "Shell Completion" section
- QUICKSTART.md: Mention tab completion
- docs/COMMANDS.md: Document `air completion` command
- Installation docs: Include completion setup

## Actions Taken
- [ ] Verify Click >=8.0 requirement
- [ ] Implement completion helpers
- [ ] Add shell_complete to commands
- [ ] Create air completion command
- [ ] Test in bash, zsh, fish
- [ ] Update documentation
- [ ] Add to pyproject.toml if needed

## Files Changed
- (To be implemented)

## Outcome
⏳ In Progress - Design phase

## Notes
This is a design task. Implementation will follow.

Shell completion is a huge quality-of-life improvement. Users shouldn't have to remember resource names or task IDs.

Key insight: Dynamic completion (reading from config) makes this much more valuable than static command completion alone.
