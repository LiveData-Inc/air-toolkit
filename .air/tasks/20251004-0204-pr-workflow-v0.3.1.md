# Task: PR workflow v0.3.1

**Created:** 2025-10-04 02:04 UTC

## Prompt

Implement air pr command to create pull requests for collaborative resources, completing the contribute workflow with change detection and automated PR creation.

## Actions Taken

- Creating task file for v0.3.1 work
- Reviewing existing pr.py stub

## Files Changed

- src/air/commands/pr.py
- src/air/services/pr_generator.py (new)
- tests/unit/test_pr_generator.py (new)
- tests/integration/test_commands.py
- docs/COMMANDS.md
- CHANGELOG.md
- pyproject.toml

## Outcome

✅ Success

## Notes

**Goal:** Implement `air pr` command for pull request workflow ✅

### Implementation Complete

Successfully implemented full PR workflow with all planned features:

1. ✅ Change detection in contributions/{resource}/ directory
2. ✅ Resource validation (collaborative type, git repo)
3. ✅ Auto-generated PR title/body from last 5 task files
4. ✅ GitHub CLI (`gh pr create`) integration
5. ✅ Options: --draft, --base, --title, --body, --dry-run
6. ✅ List collaborative resources when no resource specified
7. ✅ File copying from contributions to resource
8. ✅ Git operations: branch creation, commit, push
9. ✅ Branch name sanitization

### Components Created

**Service Module:** `src/air/services/pr_generator.py` (363 lines)
- `detect_changes()` - Find files in contributions directory
- `generate_pr_metadata()` - Auto-generate PR title/body from tasks
- `create_pr_with_gh()` - Create PR via gh CLI
- `copy_contributions_to_resource()` - Copy files to target repo
- `git_create_branch_and_commit()` - Git operations (branch, commit, push)
- `check_gh_cli_available()` - Verify gh CLI setup
- `is_git_repository()` - Validate git repos
- `_sanitize_branch_name()` - Clean branch names (air/{title})

**Command:** `src/air/commands/pr.py` (217 lines)
- Complete workflow implementation
- Error handling for all edge cases
- Rich terminal output with progress indicators
- Dry-run mode for preview

**Tests:** 39 new tests
- 30 unit tests in `tests/unit/test_pr_generator.py`
- 9 integration tests in `tests/integration/test_commands.py`

### Test Results

**278 tests total - All passing ✅**
- Was: 237 tests
- Added: 39 tests (30 unit + 9 integration)
- Test coverage for all PR workflow scenarios

### Documentation

- Updated COMMANDS.md with comprehensive `air pr` documentation
- Added examples for all scenarios
- Documented auto-generated PR metadata format
- Added gh CLI installation instructions
- Updated CHANGELOG.md for v0.3.1
- Updated pyproject.toml version to 0.3.1

### Workflow Example

```bash
# Link collaborative resource
air link add docs:~/repos/docs --collaborate

# Make improvements, copy to contributions
cp improved-docs/* .air/contributions/docs/

# Create PR (auto-generated title/body from tasks)
air pr docs

# Or with custom metadata
air pr docs --title="Add API docs" --body="Comprehensive API guide" --draft

# Or preview first
air pr docs --dry-run
```

The PR workflow is now complete and fully tested.
