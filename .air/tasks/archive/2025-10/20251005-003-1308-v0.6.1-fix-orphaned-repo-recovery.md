# Task: v0.6.1.post1 - Orphaned Repository Recovery

## Date
2025-10-05 13:08

## Prompt
Fix air upgrade to allow recovery of linked repos that are not in air-config.json. Also handle missing config file gracefully.

## Problem
If `air upgrade` is run and:
- No `air-config.json` is found → command would error out
- Repos exist in `repos/` directory but aren't listed in air-config.json → they remain orphaned

This can happen when:
- Config file is manually edited incorrectly
- Config is deleted or corrupted
- Project is migrated/copied and config gets out of sync
- Manual cleanup removes repo entries

## Solution Implemented

### 1. Missing Config Recovery
- Check if air-config.json exists at startup
- If missing, create a minimal valid config
- Use project directory name as project name
- Default to mixed mode
- Initialize empty resources dict

### 2. Orphaned Repo Detection
- Scan `repos/` directory for all symlinks
- Compare against resources in air-config.json
- Identify symlinks that aren't referenced in config
- Track as orphaned repos

### 3. Automatic Recovery
- Added new upgrade action: "recover_repos"
- Use classifier to determine repo type and tech stack
- Add orphaned repos back to config with:
  - Resolved symlink target as path
  - Classified resource type
  - Detected technology stack
  - review-only relationship (safe default)
- Write updated config

### 4. Bug Fix
- Fixed `get_project_root()` to look for `.air` directory (not `.ai`)
- This was preventing detection of AIR projects when config was missing

## Actions Taken

1. ✅ Updated `air upgrade` command to create config if missing
2. ✅ Added `_check_orphaned_repos()` helper function
3. ✅ Added `_recover_orphaned_repos()` helper function
4. ✅ Integrated orphaned repo detection into upgrade workflow
5. ✅ Added recover_repos action type and handler
6. ✅ Fixed `.ai` → `.air` directory detection bug
7. ✅ Added 3 integration tests for orphaned repo scenarios
8. ✅ Updated test for missing config (now succeeds instead of fails)
9. ✅ Updated CHANGELOG.md with v0.6.1-fix entry
10. ✅ Updated command docstring with recovery features

## Files Changed

- `src/air/commands/upgrade.py` - Added orphaned repo detection and recovery
- `src/air/services/filesystem.py` - Fixed `.ai` → `.air` directory detection
- `tests/integration/test_upgrade_command.py` - Added 3 new tests, updated 1 test
- `tests/unit/test_filesystem.py` - Fixed test to use `.air` directory
- `CHANGELOG.md` - Added v0.6.1-fix release notes

## Tests

All 410 tests passing:
- `test_upgrade_detects_orphaned_repos` - Detects orphaned symlinks
- `test_upgrade_recovers_orphaned_repos` - Recovers them into config
- `test_upgrade_skips_broken_symlinks` - Handles broken symlinks gracefully
- `test_upgrade_missing_config_file` - Creates config if missing (updated)
- `test_get_project_root_with_ai_dir` - Finds `.air` directory (fixed)

## Outcome
✅ Success

`air upgrade` can now:
1. Create air-config.json if missing
2. Detect orphaned repos in repos/ directory
3. Automatically classify and recover them
4. Handle broken symlinks gracefully
5. Correctly detect AIR projects via .air directory

## Notes

**Safe Defaults:**
- Recovered repos are added as review-only (not develop)
- Users can change to develop later with `air link` if needed
- Backup created by default before recovery

**Classification:**
- Uses existing classifier to detect repo type
- Preserves technology stack information
- Gracefully handles classification failures (defaults to library)

**Use Cases Solved:**
- Corrupted config recovery
- Missing config bootstrapping
- Partial migration support
- Manual cleanup recovery
